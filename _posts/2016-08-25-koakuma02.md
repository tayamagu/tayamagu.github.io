---
layout: post
title: 第2章 DNSって何?
date: 2016-08-25
tags: 小悪魔女子大生日記
category: 小悪魔女子大生日記
---

## DNS

ドメインネームシステム(Domain Name System)  
ホスト名を元に、ホストのIPアドレスを教える。  
IPアドレスとドメイン名を結びつける**名前解決**を行うものである  

例  
`co-akuma.` `directorz.` `jp`
```
jp ：「トップレベルドメイン(TLD)」 ･･･国ごとのCCTLD (日本=jp カナダ=ca フランス=fr)...etc
```
```
directorz ：「セカンドレベルドメイン(SLD)」 ･･･neやco、地域型ドメイン、組織型ドメイン等が使われる
```
```
co-akuma ：「ホスト名」 ･･･ネットワーク上のコンピュータの名前
```

### サブドメイン
ドメインの中のドメインのこと。あるドメインの1つ下にあるドメイン。

|●|usagi|usausa|usao|
|:---:|:---:|:---:|:---:|
|ルートドメイン|TLD|SLD|ホスト名|


op1=>operation: 　●　
op2=>operation: usagi
op3=>operation: usaus
op4=>operation: usao
op1->op2->op3->op4


**usausa.usagi** は、**usagi**のサブドメイン  
**usao.usausa.usagi**は、**usausa.usagi**のサブドメイン

### ルートドメイン
ツリー構造の中で、トップレベルドメインよりさらに上を管理している。  
階層構造の頂点。

### DNSサーバ
ドメイン名をIPアドレスに直して、コンピュータにわかるようにする作業をするのが「**DNS**」  
そして、そのシステムを行うコンピュータやサーバ、ソフトウェアを「**DNSサーバ**」と呼ぶ。

ドメイン名とIPアドレスを対応付けするこの仕事の事を「**名前解決**」と呼ぶ。


|ユーザ|DNSサーバ|PC|
|:---:|:---:|:---:|
|http:aiueo.direct.jp を見たい！⇒|aiueo.direct.jpがドメイン名だから  IPアドレスは125.6.176.●●ですよ ⇒|OK|


### DNSの3つの働き
**コンテンツサーバ** ：情報の有無の答えのみを知らせてくれる</p>
**スタブリビルバ** ：再帰問い合わせをする</p>
**フルサービスリゾルバ** ：反復問い合わせをする。キャッシュサーバとも呼ばれる。


### ルートサーバ
DNSのドメイン名前空間の頂点のサーバ。  
ルートドメインの空間を管理しているのがルートサーバで、世界に13個存在している。  
```
※13個というのは、運用主体の数であり、実際は IP Anycastによって複数のサーバがrootを管理している。
```
全てのルートサーバは、a.root-servers.net から m.root-servers.netの正式名称を持っている。  
日本のルートサーバは、**M.ROOT-SERVERS.NET**

また、日本のM.ROOT-SERVERS.NETを管理しているのが、**WIDEプロジェクト**

## digコマンド
domain infomation groper　の略  
```
$ dig [ドメイン名][レコードタイプ]```
と入力すると、そのドメインに関するデータが調べられる。  
そのデータの形の事を「**レコード**」という。

### レコード

DNSによって得られるドメイン名、IPアドレス、DNSサーバなどのさまざまなデータが提供される形。

**レコードタイプ**

> Aレコード  
> NSレコード  
> SOAレコード  
> MXレコード  
> TXTレコード  

### Aレコード
ドメイン名から、IPアドレスを調べる(正引き)コード。

```
$ dig co-akuma.directrz.jp
```
と入力すると
```
;;ANSWER SECTION:
co-akuma.directorz.jp.  3600  IN  A  126.6.176.32
```
と出る。これは  
「co-akuma.directorz.jp というドメインに対応するIPアドレスは 125.6.176.32です。」と表示されている。

- レコードとして得られた情報は、しばらくの間**キャッシュ**される。
 - このレコードのキャッシュの有効期限を秒数で書いているのが「**TTL**」
 - ここでは、3,600(秒)となっているので1時間キャッシュされる。

### NSレコード
ゾーン権限を持つDNSサーバを指定するレコード。
```
$ dig
```
と、ターミナルで`dig`とだけ入力すると、

```
;;QUESTION SECTION:
;.IN NS
;;AMSWER SECTION:
.518400 IN NS a.root-servers.net.
              |　b ~ l
.518400 IN NS m.root-servers.net.
```
と出る。


### MXレコード
MXレコードは、メールアドレスに利用するドメイン名を指定するレコード。  
メールアドレスは、ユーザ名 + ドメイン名 でできている。
```
$ dig directorz.jp mx
```
と入力すると、
```
;;ANSWER SECTION:        ↓プリファレンス値
directorz.jp. 1736 IN MX 3 mail.directorz.jp
```
と表示される。  
ここでは、「＠の後ろがdirectorz.jpとなっているメールアドレスに送られたメールは、mail.directorz.jpのメールサーバが受け取ります。」と書かれている。

- MXレコードには、メールサーバの優先順位をつける、**プリファレンス値**がある。

 - プリファレンス値が小さい方が優先される。
 - トラブルが起きた場合、次にプリファレンス値の小さなメールサーバに配送される。

### SOAレコード
ゾーン権限を持っているDNSサーバと、その詳細が書かれているレコード。
```
$ dig directorz.jp soa
```
と入力すると、


```
;;ANSWER SECTION:  
directorz.jp. 2560 IN SOA  dnsl.directorz.jp. hostmaster.directorz.jp.  
1286337318  16384  2048  1048576  2560  
    ①        ②     ③      ④      ⑤  
```


数字が沢山並んでいるのは、ゾーン管理のための情報。  
DNSでは、複数のサーバでゾーン管理することによって、DNSサーバの負担を天元したり、障害が発生しても、すぐに対策できるようになっている。  


```
① シリアルナンバー 				 			：1286337318 [Serial]  
② ゾーンファイル更新時間				 		：16384	  [refresh]  
③ 確認失敗時の再試行時間					 	：2048 	  [retry]  
④ 確認失敗時のゾーンの有効期限   			 	：1048576	[expiry]  
⑤ 問い合わせレコードが存在しない事をキャッシュする時間：2560	   [minimum]  
```


ネームサーバには、管理者が設定する**マスタサーバ**と、そのデータのコピーを持つ**スレーブサーバ**が存在する。  
このスレーブサーバによるマスタサーバのゾーン情報をコピーする作業を、「**ゾーン転送**」という。

---
### ① serial  
スレーブサーバは、もらったSOAレコードのserialを確認し、自分のserialより大きい数字だった場合、**ゾーン転送**する。

### ② refresh
新しい情報になっているか確認するまでの時間。  
指定した時間が過ぎると、マスタサーバの情報が新しいものになっていないか確認するため、スレーブサーバはマスタサーバにSOAレコードを要求する。

### ③ retry
refreshで指定した時間後の確認がうまくいかなかった場合、もう一度確認に行くまでの時間がretry。

### ④ expiry
retryを何度行っても確認ができなかった場合、expiryに指定した時間後にスレーブサーバは、**そのゾーンのサーバとして動くのをやめる。**

### ⑤ minimum
ネガティブキャッシュのTTL。  
存在しないドメイン名を尋ねても「ありません」という答えが返ってくるだけで、その「ありません」という返事をキャッシュするのがネガティブキャッシュ。

---

### TXTレコード
文章(テキスト)をドメイン名に関連付けられるのが**TXTレコード**。
```
$ dig directorz.jp txt
```
と入力すると、
```
;;ANSWER SECTION:

directorz.jp. 3600 IN TXT "v = spf1 ip4:125.6.176.0/24.
ip4:211.125.109.73   ip4:219.94.152.26  ~all"
```
が表示される。  
ここでは、「directorz.jpというドメインは、IPアドレスはIPv4で記述されていて、125.6.176.0/24(他2つ)以外のIPアドレスからdirectorz.jpとして送られてきたメールは、なりすましの可能性があるためできるだけ受信しないでください。」  
と書いてある。

※TXTレコードは、DNSの拡張用に用意されたレコードっで、最近では主にメールサーバのIPアドレスを確認して、送信メールのなりすましを防ぐために使われている。


### まとめ
①digとは、DNSサーバから情報を取得するためのコマンド  
②dig[ドメイン名(FQDN)][レコードタイプ]と入力すると、そのドメインに関するデータが調べられる  
③そのデータの形がレコードで、レコードには様々なレコードタイプがある  
④Aレコードは、ドメイン名(FQDN)からIPアドレスを調べる正引き用レコード  
⑤NSLコードは、ゾーン権限を持つDNSサーバの特定のためのレコード  
⑥MXレコードは、メールアドレスに利用するドメイン名の指定のためのレコード  
⑦SOAレコードは、ゾーンファイルが持つゾーン情報が記述されたコード  
⑧TXTレコードは、テキストをドメイン名に関連付けできるレコード

## whoisコマンド
ドメイン名などの情報を見ることができるコマンド

```
$ whois -h whois.jprs.jp directorz.co.jp/e
```
日本のドメイン名を管理しているのは、**JPRS(日本レジストラサービス)**    

***ドメイン名とIPアドレスの管理組織***  
```
[IPアド]          [IPアド]  
   →	APNIC     →
  ↑　　　　　　   　　↓
ICANN	 →   　　JPNIC     →     JPRS
      [ドメイン名]      [ドメイン名]
```
このため、検索先サーバには、ドメイン名登録を管理しているJPRSのwhoisサーバが入っている。

･･･whoisを検索すると

```
Domain Name

a.[Domain Name]			   D5RECTORZ.CO.JP  
g.[Organization]		  	Directorz Co., Ltd.  
l.[Organization Type]	     corporation  
m.[Administrative Contact]	KK19885JP  
n.[Technical Contact]		 KK19885JP  
p.[Name Server]			   dns1.directorz.jp  
p.[Name Server]			   dns2.directorz.jp  
[State]			  		 Connected(2010/10/31)  
[Registerd Date]	  		2008/10/31  
[Connected Date]	  		2008/10/31  
[Last Update]		  	   2009/11/01 01:48:21(JST)  
```

Organization = 組織・団体名  
Administrative Contact = 管理者  
Technical Contact = 技術担当者名  
Namse Server = サーバ名  
State = ドメイン名の期限切れ日  
Connected Date = 登録して使い始めた日  
Last Update = 最終期間更新日


ドメイン名には権利期間があり一般的には1年たつと更新手続きを行う必要があります。

```
$ whois -h whois.jprs.jp KK19885/e
```

と入力すると管理者情報が見れる。
　
```
$ whois -h whois.nicad.jp 182.161.76.35
```
と入力すると、IPアドレスも検索できる。  
※サーバの中でwhoisのサービス用ポート番号として割り当てられているのは43番ポート


### 逆引き
ドメイン名からIPアドレスを調べることを、**「正引き」**という。  
DNSがこの正引きをしてくれることで、様々なサイトを見たりすることが出来る。  

その反対に、IPアドレスからドメイン名を調べることを**「逆引き」**という。

【ドメイン名】から【IPアドレス】を調べること　→　**「正引き」**   
<p class="alert">【IPアドレス】から【ドメイン名】を調べること　→　**「逆引き」**

  
逆引き用のドメインはIPアドレスを逆順に並べたものに、in-addr.arpaの付いた形をしている。  

*逆引きのコマンド*
```
$ dig 32.176.6.125.in-addr.arpa. ptr
                                  ↑PRTコマンド
                                   IPアドレスからドメイン名を調べる
```
または
```
$ dig -x 125.6.176.32.in-addr.arpa. ptr
でもOK
```
と入力すると対応するドメイン名が見られる。
