---
layout: post
title: 第5章 サーバ管理のこと
date: 2016-08-31
tags: 小悪魔女子大生日記
category: 小悪魔女子大生日記
---

## サーバエンジニア
インターネットの世界で、サーバのシステムを設計したり、監理したり、運用したり、トラブル対策したり･･････する人のこと

サーバエンジニアの**使命**...
サーバ上で稼働するサービスの停止を1分1秒でも**短く**すること

### サーバエンジニアの業務内容
### ---構築業務---
**1. サーバ構成の設計**  
　　実際にその案で運用して大丈夫かチェックする。  
　　(ネットワークの大きさ、利用電源容量、コスト...etc)

**2. 物理作業**  
　　サーバはラックに積まれて運用されている。  
　　なので後々メンテナンスがしやすいように、ケーブルを自作したり、床下に潜って配線したり...

**3. OSやサーバアプリケーションのインストール設定**  
　　Webサーバとして使うのなら、Apacheをインストールしたり...  
　　UNIXならCentOS等をインストール等...  

### ---保守業務---
**1. 設定変更**  
　　メールサーバだと、人数が増えたからアドレスを追加する...  
　　Webサーバならいつもより多めに人数が来ても大丈夫なように設定する（チューニング）...  
　　などの設定変更がある。

**2. 監視**  
　　ステータスコードが`「200 OK」`と出ているか監視専用のプログラム（nagiosなど）を使って自動的に確認する。

**3. 障害対応**  
　　エラーが出た際、ログを見たり、ステータスコードのエラーコードを見たりして復旧のために<u>原因を探す</u>。


**4. 原因調査**  
　　障害の原因としては、ハードが壊れて起動していなかったり、プログラムミスやアクセス過多などが考えられる。  
　　<u>日々の状態を記録</u>させる設定（原因調査のための事前準備）をしておくことが大切。

**5. ログ解析**  
　　障害対応の際よく見るログ、このログを<u>常日頃から解析</u>をしておくことでより早く原因がつきとめられる。

**6. バックアップ**  
　　バックアップを取ることにより、人的ミスや、災害等によってデータが消えてしまった場合に  
　　<u>元の状態に戻す</u>ことができる。

**7. 定期検診**  
　　定期的に外部から攻撃を受けていないかチェックしたり、セキュリティ的に対策ができているかをチェックする。

**8. 相談を受ける**  
　　サーバのこと以外の相談、例えばプログラムのことなど聞かれることもあるので、  
　　<u>サーバ以外の知識</u>も多少必要になってくる。

### SSH
Secure SHell(セキュア シェル)の略。  
サーバが目的どおり動くよう設定を編集したり、プログラムの開始や停止をするために、**サーバを外部から操作したりするためのサーバ管理のツール**。

コンピュータを離れた場所から管理作業をする場合、**マウスとアイコンを使った方法(GUI)**では、デスクトップ画面すべての情報をインターネット経由で送らなければいけないが、**文字だけで管理する方法(CUI)**ならば、やりとりするのは文字情報だけで済む。文字で管理する方法の方が、送るべき**データの量が圧倒的に少なく**て済む。

<font size="3">**sshの流れ**</font>  
ユーザがローカルホストに入力したコマンドをsshクライアントが受け、ネットワークを通してsshサーバへ送り、リモートホストであるサーバコンピュータにコマンドを実行させる。
<div class="flow">

op1=>operation: ローカルホスト  
op2=>operation: sshクライアント  
op3=>operation: インターネット  
op4=>operation: sshサーバ  
op5=>operation: リモートホスト  


op1->op2->op3->op4->op5
</div>

**GUI** ：コンピュータグラフィックとマウスやトラックボール、タッチパッドなどのポインティングデバイスを用いて、**直感的な操作を可能にする操作方法**  
Graphical User Interfaceの略。

**CUI** ：ユーザに対する情報の表示を文字によって行い、**すべての操作をキーボードを用いて行う**  
Character User Interfaceの略。

システム管理作業では、**管理者のパスワードやセキュリティ設定情報をやりとりすることがある**。  
もしインターネットを通じてシステム管理をすると、**機密度の高い情報**がそのままの形でインターネットに流れていくことになる。途中で誰かが**盗み見たり（盗聴）**、通信内容を**偽造（改竄）**する可能性はゼロではない。

そこで、sshで行われるのは**通信経路全体の暗号化**。  
sshでは、sshクライアントとsshサーバの間での通信を暗号化している。  
そのため、もし途中で誰かが盗み見ようとしても、通信内容を知ることはとても難しく、危険なネットワークを**安全に通す**ことができる。

### IPの制限
sshのIPアドレス制限では、**`/etc/hosts.allow`**　と　**`/etc/hosts.deny`**　の２つのファイルに設定することで、特定のIPを拒否したり、自分以外のIPすべてを拒否したりできる。

**設定方法**  
```
$ ssh [サーバ名]
```
でサーバに接続して、パスワードを入力

```
$ su
```
でroot権限に

```
# vi /etc/hosts.deny
```
で/etc/hosts.denyの編集。iで編集モードにして**```sshd:ALL```**と一番下に書き、[Esc]で編集を終わらせ、**`:wq`**で保存して終了。

この状態にすると、すべてのIPアドレスが拒否される。  
ターミナルをもう１つ開いて、
```
$ ssh [サーバ名]
```
と入力してもログインできなければ設定が出来ています。

次に`/etc/hosts.allow`の設定。  
```
# vi /etc/hosts.allow
```
で、/etc/hosts.allow

** i **で編集モードにして、`sshd : [許可するIPアドレス]`と書き、[Esc]で編集を終わらせて、 :wqで保存する。

もう１つ開いていたターミナルで、
```
$ ssh [サーバ名] , パスワード
```

と入力し、パスワードを入れてログインできれば設定できている。

## 共通鍵方式　と　公開鍵方式
sshでは、共通鍵方式と公開鍵方式の２つのKEY認証の方式を利用しており、それぞれの弱点を補いながらデータの暗号をしている。

### 共通鍵方式

クライアントとサーバがお互い同じ鍵を使用して、暗号化を行う。  
共通鍵方式では、お互いに同じ共通鍵を持っていなければ解読することはできない。  

しかし、共通鍵方式は１つの鍵で暗号化と複合化を行うため、ネットワークにそののまま流してしまうと、鍵が第３者にわたって通信データを盗聴されてしまう危険がある。

### 公開鍵方式

暗号化をする公開鍵と複合化をする秘密鍵の２つの鍵を使う。  
暗号化に使う公開鍵はネットワークに流すが、複合化を行う秘密鍵を流すことはないので、安全に通信を行うことができる。  
しかし、公開鍵方式は、効率が悪く、CPUパワーをたくさん使ってしまう。

### SSHでは
そこで、SSHでは共通鍵を渡すときにのみ公開鍵方式を使って暗号化・複合化を行い、共通鍵を渡した後は共通鍵を使って通信を行うようになった。  
また、共通鍵を送受信のセッションごとに使い捨てで使用することで、通信データはより強固なものになった。

### ホスト認証の仕組み

クライアントが SSH サーバーに接続すると、最初に行われるのが問題のホスト認証で、接続しようとしているサーバーが正しいものであることをクライアントが検証するプロセスである。

ホスト認証は以下の手順で行われる

1. サーバーがホスト公開鍵とサーバー公開鍵をクライアントに送信する。

1. クライアントは、"~/.ssh/known_hosts" に登録されたデータと照合して、ホスト公開鍵が正しいかどうかを検証する（初回の接続のときはどうにもならないので、ユーザーに確認する）。

1. ホスト公開鍵が正しければ、クライアントは以後の通信で使う共通鍵をランダムに生成し、ホスト公開鍵とサーバー公開鍵で暗号化してサーバーに送信する。

1. サーバーはクライアントから受け取ったデータをホスト秘密鍵とサーバー秘密鍵で復号し、共通鍵を取得する。

### ユーザ認証の仕組み
これはホスト認証とは逆に、サーバーがクライアントの正当性を検証するプロセス。

公開鍵認証は、実際には公開鍵暗号を使ったチャレンジ・レスポンス認証です。具体的な手順は以下の通り行われる。

1. クライアントはユーザー名とユーザーの公開鍵をサーバーに転送する。

1. サーバーは、クライアントの公開鍵が "~/.ssh/authorized_keys" に登録されているかどうかをチェックする。

1. 登録されていた場合は、ランダムな値を生成し、クライアントの公開鍵で暗号化して送信する。

1. クライアントは、受け取ったデータを自分の秘密鍵で復号し、その結果をサーバーに送り返す。

1. サーバーは返送されたデータと暗号化前のデータを比較し、それらが等しければユーザーを認証する。

**チャレンジ・レスポンス認証** ：ユーザ認証に使われる文字列に特殊な処理を施すことにより、通信途中にパスワードなどが盗聴されるのを防ぐ認証方式